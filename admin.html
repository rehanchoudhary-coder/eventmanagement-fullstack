<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventFlow - ADMIN PANEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- UPDATED: We no longer need the 'firebase-storage-compat.js' script -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold text-purple-400 mb-8">EventFlow - Admin Panel</h1>

        <!-- Admin Login Section (FIXED: Restored missing form HTML) -->
        <div id="admin-login-section" class="mb-8 p-6 bg-gray-800 rounded-lg shadow-lg max-w-lg mx-auto">
            <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label for="admin-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="admin-email" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="admin-password" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300">Login as Admin</button>
                <div id="admin-login-error" class="mt-4 text-red-400 text-sm hidden"></div>
            </form>
        </div>

        <!-- Admin Content (Hidden by default) -->
        <div id="admin-content" class="hidden">
            <p class="mb-4 text-lg">Welcome, <span id="admin-user-email" class="font-bold text-purple-300"></span>! <button id="admin-logout-btn" class="ml-4 text-red-400 hover:underline text-sm">(Logout)</button></p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Section 1: Add New Event (Unchanged HTML) -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Add New Event</h2>
                    <form id="add-event-form" class="space-y-4">
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-gray-300 mb-1">Event Name</label>
                            <input type="text" id="event-name" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label for="event-date" class="block text-sm font-medium text-gray-300 mb-1">Event Date & Location</label>
                            <input type="text" id="event-date" placeholder="e.g., Dec 25, 2025 | Mumbai" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label for="event-description" class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                            <textarea id="event-description" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required></textarea>
                        </div>
                        <div>
                            <label for="event-price" class="block text-sm font-medium text-gray-300 mb-1">Price (in Rupees ₹)</label>
                            <input type="number" id="event-price" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label for="event-image-file" class="block text-sm font-medium text-gray-300 mb-1">Event Image</label>
                            <input type="file" id="event-image-file" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700" required>
                        </div>
                        <button type="submit" id="add-event-btn" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Add Event</button>
                    </form>
                    <div id="event-success-message" class="mt-4 text-green-400 text-sm hidden"></div>
                    <div id="event-error-message" class="mt-4 text-red-400 text-sm hidden"></div>
                    <!-- REMOVED: Progress bar is no longer needed -->
                </div>

                <!-- Section 2: Manage Events (Unchanged HTML) -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Manage Events</h2>
                    <div id="event-list-admin" class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-400">Loading events...</p>
                    </div>
                </div>

                <!-- Section 3: View Bookings (Unchanged HTML) -->
                <div class="p-6 bg-gray-800 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Live Bookings</h2>
                    <div id="booking-list" class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-400">Loading bookings...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config (Unchanged) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtSTnhfpnETChEwEWz47fB3OVDlTxohD8", 
            authDomain: "eventflow-app-52e44.firebaseapp.com",
            projectId: "eventflow-app-52e44",
            storageBucket: "eventflow-app-52e44.appspot.com", 
            messagingSenderId: "302829932249",
            appId: "1:302829932249:web:4af9f62236b7a5593678c8",
            measurementId: "G-TFZG8DN5Y0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // REMOVED: const storage = firebase.storage();

        // --- Get DOM Elements ---
        const loginSection = document.getElementById('admin-login-section');
        const adminContent = document.getElementById('admin-content');
        const loginForm = document.getElementById('admin-login-form');
        const loginError = document.getElementById('admin-login-error');
        const adminUserEmail = document.getElementById('admin-user-email');
        const logoutBtn = document.getElementById('admin-logout-btn');

        const addEventForm = document.getElementById('add-event-form');
        const addEventBtn = document.getElementById('add-event-btn');
        const eventSuccessMessage = document.getElementById('event-success-message');
        const eventErrorMessage = document.getElementById('event-error-message');
        
        // REMOVED: Progress bar elements
        
        const bookingList = document.getElementById('booking-list');
        const eventListAdmin = document.getElementById('event-list-admin');

        // --- Helper Function to reset button ---
        function resetFormButton() {
            addEventBtn.disabled = false;
            addEventBtn.textContent = 'Add Event';
        }
        
        // --- Helper Function to show error ---
        function showEventError(message, error) {
            console.error(message, error);
            eventErrorMessage.textContent = `${message}: ${error ? error.message : ''}`;
            eventErrorMessage.classList.remove('hidden');
            resetFormButton();
        }

        // --- Admin Authentication (Unchanged) ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value; 

            auth.signInWithEmailAndPassword(email, password)
                .then(() => loginError.classList.add('hidden'))
                .catch((error) => {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                });
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged((user) => {
            if (user) {
                if (user.email === 'rehan.choudhary@somaiya.edu') {
                    loginSection.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    adminUserEmail.textContent = user.email;
                    listenForBookings();
                    listenForEventsAdmin();
                } else {
                    console.warn('Access Denied. User is not admin:', user.email);
                    loginError.textContent = 'Access Denied. This account is not authorized.';
                    loginError.classList.remove('hidden');
                    auth.signOut();
                }
            } else {
                loginSection.classList.remove('hidden');
                adminContent.classList.add('hidden');
            }
        });

        // --- UPDATED: Add New Event Form (Using Base64) ---
        addEventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const file = document.getElementById('event-image-file').files[0];
            const eventData = {
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value,
                description: document.getElementById('event-description').value,
                price: parseFloat(document.getElementById('event-price').value),
                createdAt: new Date().toISOString()
            };

            if (!file) {
                showEventError('Please select an image file.', {});
                return;
            }

            // --- NEW: Check file size (Firestore has a 1MB document limit) ---
            if (file.size > 1048576) { // 1MB
                showEventError('Image is too large. Please select a file under 1MB.', {});
                return;
            }

            addEventBtn.disabled = true;
            addEventBtn.textContent = 'Processing Image...';
            eventErrorMessage.classList.add('hidden');
            eventSuccessMessage.classList.add('hidden');

            // --- NEW: Use FileReader to convert image to Base64 ---
            const reader = new FileReader();

            reader.onload = (e) => {
                const base64Image = e.target.result; // This is the image as a text string
                eventData.imageUrl = base64Image;
                
                addEventBtn.textContent = 'Saving Event...';

                // Save to Firestore (this is the same as before)
                db.collection('events').add(eventData)
                    .then((docRef) => {
                        console.log('Event added with ID: ', docRef.id);
                        eventSuccessMessage.textContent = 'Event added successfully!';
                        eventSuccessMessage.classList.remove('hidden');
                        addEventForm.reset();
                        resetFormButton();
                        setTimeout(() => { eventSuccessMessage.classList.add('hidden'); }, 3000);
                    })
                    .catch((error) => {
                        // Handle Firestore error
                        showEventError('Error saving event to database', error);
                    });
            };

            reader.onerror = (error) => {
                showEventError('Error reading file', error);
            };

            // Start reading the file as a Data URL (Base64)
            reader.readAsDataURL(file);
        });

        // --- Listen for Events (Admin List) ---
        // (This code works perfectly with Base64, no changes needed)
        function listenForEventsAdmin() {
            db.collection('events').onSnapshot((snapshot) => {
                eventListAdmin.innerHTML = '';
                if (snapshot.empty) {
                    eventListAdmin.innerHTML = '<p class="text-gray-400">No events added yet...</p>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const event = doc.data();
                    const eventId = doc.id;
                    
                    const eventHtml = `
                        <div class="p-4 bg-gray-700 rounded-lg flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <img src="${event.imageUrl}" alt="${event.name}" class="w-16 h-16 object-cover rounded-lg">
                                <div>
                                    <h4 class="font-bold text-lg text-white">${event.name}</h4>
                                    <p class="text-sm text-gray-300">₹${event.price}</p>
                                </div>
                            </div>
                            <button class="delete-event-btn text-red-500 hover:text-red-400 font-medium" data-id="${eventId}">
                                Delete
                            </button>
                        </div>
                    `;
                    eventListAdmin.insertAdjacentHTML('afterbegin', eventHtml);
                });
            }, (error) => {
                console.error("Error listening for events: ", error);
                eventListAdmin.innerHTML = '<p class="text-red-400">Error loading events.</p>';
            });
        }

        // --- Event Listener for Delete Buttons ---
        // (This code is simpler, as it just deletes the document, no storage to worry about)
        eventListAdmin.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-event-btn')) {
                const eventId = e.target.dataset.id;
                
                db.collection('events').doc(eventId).delete()
                    .then(() => {
                        console.log('Event deleted successfully');
                    })
                    .catch((error) => {
                        showEventError('Error deleting event', error);
                    });
            }
        });

        // --- Listen for Bookings (Unchanged) ---
        function listenForBookings() {
            db.collection('bookings').onSnapshot((snapshot) => {
                bookingList.innerHTML = '';
                if (snapshot.empty) {
                    bookingList.innerHTML = '<p class="text-gray-400">No bookings yet...</p>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const booking = doc.data();
                    const bookingHtml = `
                        <div class="p-4 bg-gray-700 rounded-lg">
                            <h4 class="font-bold text-lg text-white">${booking.event}</h4>
                            <p class="text-sm text-gray-300">Booked by: <span class="font-medium">${booking.name}</span> (${booking.email})</p>
                            <p class="text-sm text-gray-300">Phone: ${booking.phone} | WhatsApp: ${booking.whatsapp}</p>
                            <p class="text-sm text-gray-300">Attendees: ${booking.attendees}</p>
                            <p classs="font-semibold text-green-400">Total Cost: ₹${booking.totalCost.toFixed(2)}</p>
                            <p class="text-sm text-gray-400">Payment Mode: ${booking.paymentMode}</p>
                            <p class="text-xs text-gray-500 mt-2">Booked on: ${new Date(booking.timestamp).toLocaleString()}</p>
                        </div>
                    `;
                    bookingList.insertAdjacentHTML('afterbegin', bookingHtml);
                });
            }, (error) => {
                console.error("Error listening for bookings: ", error);
                bookingList.innerHTML = '<p class="text-red-400">Error loading bookings.</p>';
            });
        }

    </script>
</body>
</html>

